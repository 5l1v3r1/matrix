<!DOCTYPE html>
<html>
	<head>
		<title>The Matrix Has You...</title>

		<meta charset="utf-8"/>

		<style>
			* {
				margin: 0px;
				padding: 0px;
			}

			html, body {
				width: 100%;
				height: 100%;
			}

			body {
				background: #000;
			}

			canvas {
				width: 100%;
				height: 100%;

				display: block;

				background: #000;
			}

			@font-face {
				font-family: 'Matrix Code NFI';
				src: url('font/matrix-code-nfi.woff');
			}

			@font-face {
				font-family: 'Terminus TTF';
				src: url('font/terminus-ttf.woff');
			}
		</style>

		<script>
			if (!document.fullscreen) {
				var fullscreenPolyfill = new Object();

				fullscreenPolyfill.fullscreen = false;
				fullscreenPolyfill.fullscreenEnabled = false;
				fullscreenPolyfill.fullscreenElement = undefined;

				fullscreenPolyfill.fullscreenchangeEvent = undefined;
				fullscreenPolyfill.fullscreenerrorEvent = undefined;

				fullscreenPolyfill.reload = function() {
					document.fullscreen = document.mozFullScreen || document.webkitIsFullscreen || fullscreenPolyfill.fullscreen;
					document.fullscreenEnabled = document.mozFullScreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled || fullscreenPolyfill.fullscreenEnabled;
					document.fullscreenElement = document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement || fullscreenPolyfill.fullscreenElement;
				}

				fullscreenPolyfill.onfullscreenchange = function(e) {
					if (e === fullscreenPolyfill.fullscreenchangeEvent)
						return;

					e.stopPropagation();

					var ev = document.createEvent('Event');
					ev.initEvent('fullscreenchange', true, false);

					fullscreenPolyfill.fullscreenchangeEvent = ev;

					e.target.dispatchEvent(ev);

					if (document.onfullscreenchange)
						document.onfullscreenchange(ev);

					fullscreenPolyfill.reload();
				}

				document.addEventListener('mozfullscreenchange', fullscreenPolyfill.onfullscreenchange, false);
				document.addEventListener('webkitfullscreenchange', fullscreenPolyfill.onfullscreenchange, false);
				document.addEventListener('msfullscreenchange', fullscreenPolyfill.onfullscreenchange, false);

				fullscreenPolyfill.onfullscreenerror = function(e) {
					if (e === fullscreenPolyfill.fullscreenerrorEvent)
						return;

					e.stopPropagation();

					var ev = document.createEvent('Event');
					ev.initEvent('fullscreenerror', true, false);

					fullscreenPolyfill.fullscreenerrorEvent = ev;

					e.target.dispatchEvent(ev);

					if (document.onfullscreenerror)
						document.onfullscreenerror(ev);

					fullscreenPolyfill.reload();
				}

				document.addEventListener('mozfullscreenerror', fullscreenPolyfill.onfullscreenerror, false);
				document.addEventListener('webkitfullscreenerror', fullscreenPolyfill.onfullscreenerror, false);
				document.addEventListener('msfullscreenerror', fullscreenPolyfill.onfullscreenerror, false);

				document.exitFullscreen = function() {
					var exitFullscreen = document.mozCancelFullScreen || document.webkitExitFullscreen || document.msExitFullscreen || undefined;

					if (exitFullscreen)
						exitFullscreen.call(document);

					fullscreenPolyfill.reload();
				}

				Element.prototype.requestFullscreen = function() {
					var requestFullscreen = Element.prototype.mozRequestFullScreen || Element.prototype.webkitRequestFullscreen || Element.prototype.msRequestFullscreen || undefined;

					if (requestFullscreen)
						requestFullscreen.call(this);

					fullscreenPolyfill.reload();
				}

				fullscreenPolyfill.reload();
			}
		</script>

		<script>
			window.Matrix = function(canvas, rate, spawn, matrix, console) {
				var self = this;

				self.canvas = canvas;
				self.context = canvas.getContext('2d');

				if (typeof rate === 'undefined')
					rate = 30;

				self.rate = rate;

				self.delay = 1000/self.rate;

				if (typeof spawn === 'undefined')
					spawn = 3;

				self.spawn = spawn;

				if (typeof matrix === 'undefined')
					matrix = '24px Matrix Code NFI';

				self.matrix = matrix;

				if (typeof console === 'undefined')
					console = '24px Terminus TTF';

				self.console = console;

				self.genSpawn = function() {
					return Math.floor(Math.random()*(self.spawn + 1));
				}

				self.genCol = function() {
					do {
						var col = Math.floor(Math.random()*(self.width/self.charWidth + 1));
					}
					while (self.cols[col]);

					return col;
				}

				self.genLength = function() {
					return Math.floor(Math.random()*(self.height/self.charHeight - 5) + 6);
				}

				self.genChar = function() {
					var dictionary = '0123456789abcdefghijklmnopqrstuvwxyz';

					return dictionary.charAt(Math.floor(Math.random()*dictionary.length));
				}

				self.cols = []
				self.codes = [];

				self.Code = function(matrix, col, length) {
					var self = this;

					self.matrix = matrix;
					self.col = col;
					self.length = length;
					self.bottom = 0;

					self.chars = [];

					self.tick = function() {
						self.chars.push(self.matrix.genChar());
						self.bottom++;

						while (self.chars.length > self.length)
							self.chars.shift();

						if (self.col >= self.matrix.cols.length)
							return false;

						self.matrix.cols[self.col] = self.chars.length < self.length;

						return Math.floor((self.bottom - self.chars.length)*self.matrix.charHeight) < self.matrix.height;
					};

					self.paint = function() {
						self.chars.forEach(function(item, index) {
							if (index === self.chars.length - 1)
								self.matrix.context.fillStyle = '#ddd';
							else
								self.matrix.context.fillStyle = '#4d4';

							self.matrix.context.fillText(item, self.col*self.matrix.charWidth, (self.bottom - (self.chars.length - 1) + index)*self.matrix.charHeight);
						});
					};
				};

				self.message = null;

				self.Message = function(matrix, message) {
					var self = this;

					self.matrix = matrix;
					self.message = message;

					self.chars = 0;
					self.count = 0;

					self.cursor = '';

					self.tick = function() {
						self.count++;

						if (self.chars < self.message.length) {
							if (self.count % (self.matrix.rate/10) === 0)
								self.chars++;
						}
						else {
							if (self.count >= self.matrix.rate) {
								self.count = 0;

								if (self.cursor === '')
									self.cursor = 'â–ˆ';
								else
									self.cursor = '';
							}
						}

						return self.matrix.message === self;
					};

					self.paint = function() {
						self.matrix.context.fillStyle = '#4d4';
						self.matrix.context.fillText(self.message.substring(0, self.chars) + self.cursor, 0, self.matrix.charHeight);
					};
				};

				self.spawning = true;
				self.raining = true;
				self.writing = false;

				self.change = 0;

				self.rain = function() {
					self.change = 1;
				}

				self.write = function(message) {
					self.message = new self.Message(self, message);
					self.change = 2;
				}

				self.update = function() {
					if (self.change !== 1) {
						self.spawning = false;

						if (self.codes.length === 0)
							self.raining = false;
						else
							return;
					}
					else if (self.change !== 2) {
						self.writing = false;
						self.message = null;
					}

					if (self.change === 1) {
						self.raining = true;
						self.spawning = true;

						self.font = self.matrix;
						self.resize();

						self.change = 0;
					}
					else if (self.change === 2) {
						self.writing = true;

						self.font = self.console;
						self.resize();

						self.change = 0;
					}
					else if (self.change === 3) {
						if (self.timeout !== null)
							self.timeout = null;

						self.change = 0;
					}
				}

				self.tick = function() {
					if (self.change > 0)
						self.update();

					if (self.spawning) {
						var spawn = self.genSpawn();
						for (var code = 0; code < spawn; code++)
							self.codes.push(new self.Code(self, self.genCol(), self.genLength()));
					}

					if (self.raining) {
						self.codes = self.codes.filter(function(item, index) {
							return item.tick();
						});
					}
					else if (self.writing) {
						self.message.tick();
					}
				};

				self.scan = 0;

				self.paint = function() {
					self.context.clearRect(0, 0, self.width, self.height);

					if (self.raining) {
						self.codes.forEach(function(item, index) {
							item.paint();
						});
					}
					else if (self.writing) {
						self.message.paint();
					}

					self.context.lineWidth = 0.5;
					self.context.strokeStyle = '#777';

					for (var row = self.scan; row < self.height + 4; row += 4) {
						self.context.beginPath();
						self.context.moveTo(0, row);
						self.context.lineTo(self.width, row);
						self.context.stroke();
					}

					self.scan = (self.scan + 1) % 4;
				};

				self.clear = function() {
					self.codes = [];

					self.paint();
				};

				self.fullscreen = function() {
					if (document.fullscreenElement === self.canvas)
						document.exitFullscreen();
					else
						self.canvas.requestFullscreen();
				};

				self.timeout = null;

				self.loop = function() {
					self.tick();
					self.paint();

					if (self.timeout !== null)
						self.timeout = setTimeout(self.loop, self.delay)
				};

				self.start = function() {
					if (self.timeout === null)
						self.timeout = setTimeout(self.loop, self.delay)
				};

				self.stop = function() {
					self.change = 3;
				};

				self.font = self.matrix;

				self.resize = function() {
					self.canvas.height = window.innerHeight;
					self.canvas.width = window.innerWidth;

					self.height = self.canvas.height;
					self.width = self.canvas.width;

					self.context.font = self.font;

					self.charWidth = self.context.measureText('a').width + 6;
					self.charHeight = parseInt(self.font);

					var oldLength = self.cols.length;
					self.cols.length = Math.floor(self.width/self.charWidth + 1);
					self.cols.fill(0, oldLength);
				};

				window.addEventListener('resize', self.resize, false);

				self.resize();
			};
		</script>

		<script>
			var todo = [];
			var time = [];
			var timeout = null;

			var exec = function() {
				todo.pop()();

				if (time.length > 0)
					timeout = setTimeout(exec, time.pop());
				else
					timeout = null;
			};

			var queue = function(delay, callback) {
				time.unshift(delay*1000);
				todo.unshift(callback);

				if (timeout === null)
					timeout = setTimeout(exec, time.pop());
			};
		</script>
	</head>

	<body>
		<canvas></canvas>

		<script>
			var matrix = new Matrix(document.getElementsByTagName('canvas')[0]);
			matrix.start();

			document.addEventListener('keydown', function(e) {
				if (e.key === "f") {
					e.preventDefault();
					matrix.fullscreen();
				}
			}, false);
		</script>
	</body>
</html>
